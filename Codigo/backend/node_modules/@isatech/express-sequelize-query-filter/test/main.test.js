const express = require('express');
const request = require('supertest');
const queryFilter = require('../src/index');
const InvalidRequestFilterError = require('../src/invalid-request-filter-error');

const app = express();


app.get('/', queryFilter(), (req,res) => {
    if(req.filter){
        res.send({created: true, filter: req.filter});
    }
    else{
        res.send({created: false});
    }
});

app.get('/always-create-false', queryFilter({alwaysCreate: false}), (req,res) => {
    if(req.filter){
        res.send({created: true});
    }
    else{
        res.send({created: false});
    }
});

app.use((err, req, res, next) => {
    res.status(500).send(err);
  })



test("when not sending filter, it should build an empty filter", async () => {
    expect.assertions(3);
    const res = await request(app).get(`/`);
    expect(res.statusCode).toBe(200);
    expect(res.body.created).toBe(true);
    expect(res.body.filter).toEqual({});
});


test("when sending filter, it should build the filter", async () => {
    expect.assertions(3);
    const filter = { 
        where: {
            id: 1,
            name: 'Juan'
        }
    };
    const filterJSON = JSON.stringify(filter);
    const res = await request(app).get(`/?filter=${filterJSON}`);
    expect(res.statusCode).toBe(200);
    expect(res.body.created).toBe(true);
    expect(res.body.filter).toEqual(filter);
});

test("when sending filter, it should not build the filter if alwaysCreate option is false", async () => {
    expect.assertions(2);
    const res = await request(app).get(`/always-create-false`);
    expect(res.statusCode).toBe(200);
    expect(res.body.created).toBe(false);
});


test("when sending an invalid filter, it should throw an Exception", async () => {
    const filter = { 
        where: {
            id: 1,
            name: 'Juan'
        }
    };
    const filterJSON = JSON.stringify(filter);
    const res = await request(app).get(`/?filter=[${filterJSON}}`);
    expect(res.statusCode).toBe(500);
    expect(res.body).toEqual({name: InvalidRequestFilterError.name});
});


